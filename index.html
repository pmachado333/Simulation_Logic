<!-- file: /mnt/data/index_mmdd_v2.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Simulation Logic input generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --slb-900:#001a5e;--slb-800:#002d84;--slb-700:#003aa8;--slb-600:#175cd3;--slb-100:#e7eefc;
      --ink-900:#0b1220;--ink-700:#233047;--ink-600:#2e3c55;--ink-500:#4b5b79;--line:#d7dff2;--white:#fff
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:24px;line-height:1.35;font-size:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";
      background:var(--slb-100);color:var(--ink-900)
    }
    .page{max-width:1560px;margin:0 auto;padding:0 16px}
    h1{margin:0 0 4px;color:var(--slb-800);font-weight:800;letter-spacing:.2px;font-size:18px}
    .subtitle{color:var(--ink-500);font-size:11.5px;margin-bottom:12px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 360px;align-items:start}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:var(--white);box-shadow:0 1px 0 rgba(0,0,0,.02)}
    input,select,button{padding:6px 8px;border:1px solid var(--line);border-radius:10px;font-size:13px;background:#fff}
    input:focus,select:focus,button:focus{outline:2px solid var(--slb-600);outline-offset:2px}
    label{font-size:11px;color:var(--ink-700)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar .btn{background:var(--slb-800);color:#fff;border:none;font-weight:600}
    .toolbar .btn:hover{background:var(--slb-700);cursor:pointer}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .table-scroll{overflow-x:auto;overflow-y:visible;padding-bottom:4px}
    .row{
      display:grid;
      grid-template-columns:130px 162px 150px 214px 180px 140px 88px;
      gap:8px;margin-bottom:8px;align-items:center
    }
    .row > *{min-width:0}
    .row-head{
      font-weight:700;color:var(--slb-900);position:sticky;top:0;background:var(--white);z-index:1;
      border-bottom:1px solid var(--line);padding-top:6px;padding-bottom:6px;font-size:12.5px
    }
    .row-help{font-size:11px;color:var(--ink-500);border-bottom:1px dashed var(--line);padding-bottom:8px}
    .row-help>div{padding:2px 0}
    .row input,.row select{width:100%}
    .row input[type="date"]{font-variant-numeric:tabular-nums}
    .r-key{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row select.r-entity,.row select.r-key,.row select.r-welltype{font-size:12px;padding:4px 6px}
    .row select.r-entity option,.row select.r-key option,.row select.r-welltype option{font-size:12px}
    .row select.r-key optgroup{font-size:12px;font-style:normal}
    .r-role-cell{display:flex}
    .fake-field{
      width:100%;display:flex;align-items:center;justify-content:center;
      border-radius:10px;border:1px solid var(--ink-600);
      background:var(--ink-700);color:#fff;font-size:12px;padding:6px 8px;user-select:none
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    pre{white-space:pre-wrap;font-size:12px}
    .hide{display:none!important}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:11px;color:var(--ink-700)}
    .pill .dot{width:6px;height:6px;border-radius:50%;background:var(--slb-700);display:inline-block}
    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .muted{color:var(--ink-500);font-size:11.5px}
    .note{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#f9fbff}
    .note-title{margin:0 0 4px;color:var(--slb-800);font-weight:700;font-size:13px}
    .label-subtle{font-size:10px;color:var(--ink-500)}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Simulation Logic input generator</h1>
      <div class="subtitle">by Patrick Machado</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="toolbar">
          <div>
            <label for="startDate">Effective Date</label><br />
            <input id="startDate" type="date" aria-describedby="fmtHint" />
            <div id="fmtHint" class="label-subtle">Format: MM/DD/YYYY</div>
          </div>
          <button id="btnInit" type="button" class="btn">Initialize First Row</button>
          <button id="btnAdd" type="button" class="btn">+ Add Row</button>
          <button id="btnExport" type="button" class="btn">Export CSV</button>
          <button id="btnClear" type="button" class="btn" style="background:#e8eefc;color:#103;">Clear</button>
        </div>

        <div class="sep"></div>

        <div class="legend" aria-label="Units (ECLIPSE_FIELD)">
          <span class="pill"><strong>ECLIPSE_FIELD units</strong></span>
          <span class="pill"><span class="dot"></span>Pressure: <span class="mono">psi</span></span>
          <span class="pill"><span class="dot"></span>Gas rate: <span class="mono">MSCF/d</span></span>
          <span class="pill"><span class="dot"></span>Liquid rate: <span class="mono">STB/d</span></span>
          <span class="pill"><span class="dot"></span>Temperature: <span class="mono">°F</span></span>
        </div>

        <div class="sep"></div>

        <div class="note" role="note" aria-label="How constraints are applied">
          <div class="note-title">How constraints in this file are applied</div>
          <div class="muted">
            The rows below define date-effective operating constraints used by field management to control individual
            <strong>Wells</strong> and the terminal network node <span class="mono">NetworkSinkBoundary</span>
            (<strong>NSB</strong>). NSB is the last node of the simulation, offshore cases typically map this to the
            <strong>FPSO</strong>. For Wells, each row sets a single constraint and can optionally change the well role
            on that date. For NSB, pick either a <em>Property</em> (e.g., Pressure) or a <em>Constraint</em>
            (e.g., MAX_GAS_FLOW_RATE). Use <span class="mono">#REMOVE</span> to clear a previously set value.
          </div>
        </div>

        <div class="sep"></div>

        <div class="table-scroll">
          <div class="row row-head">
            <div>Effective Date</div>
            <div>Target</div>
            <div>Node Name</div>
            <div>Constraint / Property Name</div>
            <div>Value (ECLIPSE_FIELD)</div>
            <div>Well Role (optional)</div>
            <div>Action</div>
          </div>
          <div class="row row-help">
            <div>MM/DD/YYYY</div>
            <div>Well or NetworkSinkBoundary</div>
            <div>Well Name or Sink Name (<span class="mono">* = All</span>)</div>
            <div>Pick from Properties or Constraints</div>
            <div>Unit per <span class="mono">ECLIPSE_FIELD</span></div>
            <div>PRODUCER / INJECTOR (Well only)</div>
            <div>Delete row</div>
          </div>

          <div id="rows"></div>
        </div>

        <div class="sep"></div>
        <details open>
          <summary><strong>CSV Preview</strong> <span class="muted">(first 20 lines)</span></summary>
          <pre id="preview" class="mono"></pre>
        </details>
      </section>

      <aside class="card">
        <h3 style="color:var(--slb-800); margin-top:0; font-size:15px;">Tips for fast, correct entry</h3>
        <ul class="muted">
          <li><strong>NSB</strong> = <span class="mono">NetworkSinkBoundary</span> — the last node of the simulation (offshore: usually the FPSO).</li>
          <li>Use <span class="mono">*</span> to target all wells/sinks; patterns like <span class="mono">PROD*</span> are supported for wells.</li>
          <li><strong>Well rows</strong> set a single constraint per row.</li>
          <li><strong>Well Role</strong> writes <span class="mono">Well &lt;pattern&gt; Type</span> on that date. Leave blank if unchanged.</li>
          <li><strong>NSB rows:</strong> choose either a Property or a Constraint from the single list.</li>
          <li>For removals, use <span class="mono">#REMOVE</span> as the value.</li>
        </ul>
        <h4 style="color:var(--slb-800); font-size:14px;">Common keys</h4>
        <div class="muted"><strong>Well</strong> — OIL_PRODUCTION_RATE, WATER_PRODUCTION_RATE, GAS_PRODUCTION_RATE, LIQUID_PRODUCTION_RATE, BOTTOM_HOLE_PRESSURE, TUBING_HEAD_PRESSURE.</div>
        <div class="muted" style="margin-top:6px;"><em>NSB = NetworkSinkBoundary (last node / FPSO)</em></div>
        <div class="muted" style="margin-top:6px;"><strong>NSB (constraints)</strong> — MAX_GAS_FLOW_RATE, MAX_LIQUID_FLOW_RATE, MAX_OIL_FLOW_RATE, MAX_PRESSURE, MAX_WATER_FLOW_RATE, MIN_LIQUID_FLOW_RATE, MIN_PRESSURE.</div>
        <div class="muted" style="margin-top:6px;"><strong>NSB (properties)</strong> — Status, Pressure, Temperature, FlowBasis, GasRate, OilRate, WaterRate, LiquidRate, MassRate, Constraints.</div>
      </aside>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    window.addEventListener('error', function(e){ alert('Script error: ' + e.message); });

    // Data
    var WELL_CONSTRAINTS=[
      'OIL_PRODUCTION_RATE','WATER_PRODUCTION_RATE','GAS_PRODUCTION_RATE',
      'LIQUID_PRODUCTION_RATE','BOTTOM_HOLE_PRESSURE','TUBING_HEAD_PRESSURE','Custom...'
    ];
    var WELL_TYPES=['','PRODUCER','WATER_INJECTOR','GAS_INJECTOR','OIL_INJECTOR'];
    var NSB_PROPERTIES=['Status','Pressure','Temperature','FlowBasis','GasRate','OilRate','WaterRate','LiquidRate','MassRate','Constraints','Custom...'];
    var NSB_CONSTRAINTS=['MAX_GAS_FLOW_RATE','MAX_LIQUID_FLOW_RATE','MAX_OIL_FLOW_RATE','MAX_PRESSURE','MAX_WATER_FLOW_RATE','MIN_LIQUID_FLOW_RATE','MIN_PRESSURE','Custom...'];

    // DOM refs
    var rowsEl, previewEl, startDateEl;

    // Utils
    function fmtDateMMDDYYYY(iso){ if(!iso) return ''; var p=iso.split('-'); return p.length===3 ? (p[1]+'/'+p[2]+'/'+p[0]) : iso; }
    function csvEscape(s){ if(s==null) return ''; var out=String(s); if(/[",\n]/.test(out)){ out=out.replace(/"/g,'""'); return '"'+out+'"'; } return out; }
    function make(tag,cls){ var el=document.createElement(tag); if(cls) el.className=cls; return el; }
    function withoutCustom(arr){ return arr.filter(function(x){ return x!=='Custom...'; }); }
    function addCustomOption(sel){
      var o=make('option'); o.value='__CUSTOM__'; o.textContent='Custom...'; o.dataset.kind='custom';
      sel.appendChild(o);
    }

    function fillSelectWellConstraints(sel, preset){
      sel.innerHTML='';
      withoutCustom(WELL_CONSTRAINTS).forEach(function(t){
        var o=make('option'); o.value=t; o.textContent=t; o.dataset.kind='cons';
        sel.appendChild(o);
      });
      addCustomOption(sel);
      if(preset){ sel.value=preset; }
    }

    function fillSelectNSBCombined(sel, preset){
      sel.innerHTML='';
      var grpP=document.createElement('optgroup'); grpP.label='Properties';
      withoutCustom(NSB_PROPERTIES).forEach(function(t){
        var o=make('option'); o.value=t; o.textContent=t; o.dataset.kind='prop';
        grpP.appendChild(o);
      });
      sel.appendChild(grpP);
      var grpC=document.createElement('optgroup'); grpC.label='Constraints';
      withoutCustom(NSB_CONSTRAINTS).forEach(function(t){
        var o=make('option'); o.value=t; o.textContent=t; o.dataset.kind='cons';
        grpC.appendChild(o);
      });
      sel.appendChild(grpC);
      addCustomOption(sel);
      if(preset){ sel.value=preset; }
    }

    // Row constructor
    function addRow(dateISO, entity, name, key, value, wellType){
      var row=make('div','row');

      // date cell (single input only)
      var d=make('input','r-date'); d.type='date'; d.value=dateISO||'';
      d.addEventListener('input', function(){ renderPreview(); });

      var ent=make('select','r-entity'); ['Well','NetworkSinkBoundary'].forEach(function(x){ var o=make('option'); o.value=x; o.textContent=x; ent.appendChild(o); }); ent.value=entity||'Well';
      var n=make('input','r-name'); n.type='text'; n.placeholder='Well Name or Sink Name (* = All)'; n.value=(name==null||name==='')?'*':name;

      // Key (Constraint or Property in one select)
      var keySel=make('select','r-key r-key-nsb');
      function refillKey(){
        if(ent.value==='Well') fillSelectWellConstraints(keySel, key||undefined);
        else fillSelectNSBCombined(keySel, key||undefined);
      }
      refillKey();

      keySel.addEventListener('change', function(){
        if(keySel.value==='__CUSTOM__'){
          var type = prompt('Is this a Property (P) or Constraint (C)?');
          if(!type){ refillKey(); return; }
          var label = prompt('Enter custom name:');
          if(!label || !label.trim()){ refillKey(); return; }
          var clean=label.trim();
          if(type.toUpperCase()==='P'){
            if(NSB_PROPERTIES.indexOf(clean)===-1) NSB_PROPERTIES.splice(NSB_PROPERTIES.length-1,0,clean);
          } else if(type.toUpperCase()==='C'){
            if(ent.value==='Well'){
              if(WELL_CONSTRAINTS.indexOf(clean)===-1) WELL_CONSTRAINTS.splice(WELL_CONSTRAINTS.length-1,0,clean);
            } else {
              if(NSB_CONSTRAINTS.indexOf(clean)===-1) NSB_CONSTRAINTS.splice(NSB_CONSTRAINTS.length-1,0,clean);
            }
          } else {
            alert('Invalid type. Use P or C.'); refillKey(); return;
          }
          key = clean; refillKey(); keySel.value = clean;
        }
        renderPreview();
      });

      var v=make('input','r-value'); v.type='text'; v.placeholder='Constraint or Property value, unit per ECLIPSE_FIELD'; v.value=value||'';

      // Column #6 (Well Role cell): contains BOTH real select and dark placeholder
      var roleCell = make('div','r-role-cell');
      var wType=make('select','r-welltype');
      ['','PRODUCER','WATER_INJECTOR','GAS_INJECTOR','OIL_INJECTOR'].forEach(function(t){ var o=make('option'); o.value=t; o.textContent=(t===''?'—':t); wType.appendChild(o); });
      wType.value=(wellType==null?'':wellType);

      var rolePlaceholder = make('div','fake-field'); rolePlaceholder.textContent='N/A'; rolePlaceholder.setAttribute('aria-hidden','true');
      roleCell.appendChild(wType);
      roleCell.appendChild(rolePlaceholder);

      var del=make('button','r-del'); del.type='button'; del.textContent='🗑 Remove';

      function applyVisibility(){
        var isWell = (ent.value==='Well');
        wType.classList.toggle('hide', !isWell);            // show select only for Well
        rolePlaceholder.classList.toggle('hide', isWell);   // show dark placeholder for NSB
      }
      applyVisibility();

      ent.addEventListener('change', function(){ refillKey(); applyVisibility(); renderPreview(); });
      [ent,n,v,wType].forEach(function(inp){ inp.addEventListener('input', renderPreview); });
      del.addEventListener('click', function(){ row.remove(); renderPreview(); });

      row.appendChild(d); row.appendChild(ent); row.appendChild(n); row.appendChild(keySel); row.appendChild(v); row.appendChild(roleCell); row.appendChild(del);
      rowsEl.appendChild(row);
      renderPreview();
    }

    // CSV builder
    function buildCSV(){
      var entries=[]; var rs=rowsEl.querySelectorAll('.row');
      for(var i=0;i<rs.length;i++){
        var r=rs[i];
        var dateISO=r.querySelector('.r-date'); if(!dateISO) continue;
        var dval=dateISO.value; if(!dval) continue;

        var entity=r.querySelector('.r-entity').value;
        var name=(r.querySelector('.r-name').value.trim()||'*');

        var keySel=r.querySelector('.r-key');
        var key=(keySel && keySel.value && keySel.value!=='__CUSTOM__') ? keySel.value.trim() : '';
        if(!key) continue;

        var opt=(keySel && keySel.options[keySel.selectedIndex]) ? keySel.options[keySel.selectedIndex] : null;
        var inferredKind = (entity==='Well') ? 'cons' : (opt && opt.dataset && opt.dataset.kind==='prop' ? 'prop' : 'cons');

        var val=r.querySelector('.r-value').value.trim();
        var wtypeSel=r.querySelector('.r-welltype');
        var wtype=wtypeSel ? wtypeSel.value : '';

        entries.push({dateISO:dval,entity:entity,name:name,kind:inferredKind,key:key,val:val,wtype:wtype});
      }
      if(!entries.length) return '';

      var groups=new Map();
      function ensureGroup(gid,dateKey){ if(!groups.has(gid)) groups.set(gid,{dateKey:dateKey,map:new Map([['DATE',dateKey]])}); return groups.get(gid).map; }
      function dateKeyOf(iso){ return fmtDateMMDDYYYY(iso); }

      entries.forEach(function(e){
        var dkey=dateKeyOf(e.dateISO), gid, map;
        if(e.entity==='Well'){
          var t=e.wtype||'NONE';
          gid='DATE='+dkey+'|Well|TYPE='+t+'|NAME='+e.name;
          map=ensureGroup(gid,dkey);
          if(e.wtype){ map.set('Well '+e.name+' Type', e.wtype); }
          map.set('Well '+e.name+' Constraints:'+e.key, e.val||'');
        } else {
          gid='DATE='+dkey+'|NSB|NAME='+e.name;
          map=ensureGroup(gid,dkey);
          if(e.kind==='prop') map.set('NetworkSinkBoundary '+e.name+' '+e.key, e.val||'');
          else map.set('NetworkSinkBoundary '+e.name+' Constraints:'+e.key, e.val||'');
        }
      });

      var headers=new Set(['DATE']);
      groups.forEach(function(obj){ obj.map.forEach(function(_,h){ headers.add(h); }); });
      var cols=Array.from(headers);

      var rowsArr=Array.from(groups.entries()).map(function(x){return{gid:x[0],dateKey:x[1].dateKey,map:x[1].map};}).sort(function(a,b){
        // MM/DD/YYYY -> year=A[2], month=A[0], day=A[1]
        var A=a.dateKey.split('/'); var B=b.dateKey.split('/');
        var t=new Date(A[2],A[0]-1,A[1]) - new Date(B[2],B[0]-1,B[1]);
        if(t!==0) return t; return a.gid.localeCompare(b.gid);
      });

      var lines=[]; lines.push(cols.map(csvEscape).join(','));
      rowsArr.forEach(function(r){ var out=[]; cols.forEach(function(h){ out.push(csvEscape(r.map.get(h)||'')); }); lines.push(out.join(',')); });
      return lines.join('\n');
    }

    function renderPreview(){
      var csv=buildCSV();
      document.getElementById('preview').textContent = csv ? csv.split('\n').slice(0,20).join('\n') : '';
    }

    function download(name,text){
      var blob=new Blob([text],{type:'text/csv;charset=utf-8'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download=name;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function boot(){
      rowsEl=document.getElementById('rows');
      startDateEl=document.getElementById('startDate');

      var btnInit=document.getElementById('btnInit');
      var btnAdd=document.getElementById('btnAdd');
      var btnExport=document.getElementById('btnExport');
      var btnClear=document.getElementById('btnClear');

      var todayISO=new Date().toISOString().slice(0,10);
      startDateEl.value=todayISO;

      addRow(todayISO,'Well','*','OIL_PRODUCTION_RATE','', '');

      btnInit.addEventListener('click',function(){
        var d=startDateEl.value; if(!d){alert('Pick an effective date');return;}
        rowsEl.innerHTML=''; addRow(d,'Well','*','OIL_PRODUCTION_RATE','', '');
      });
      btnAdd.addEventListener('click',function(){
        var d=startDateEl.value||todayISO; addRow(d,'Well','*','OIL_PRODUCTION_RATE','', '');
      });
      btnExport.addEventListener('click',function(){
        var csv=buildCSV(); if(!csv){alert('No rows to export');return;} download('case_Constraints.csv',csv);
      });
      btnClear.addEventListener('click',function(){ rowsEl.innerHTML=''; document.getElementById('preview').textContent=''; });
    }
    document.addEventListener('DOMContentLoaded', boot);
  })();
  </script>
</body>
</html>
